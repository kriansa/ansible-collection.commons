---
- name: remove chrony
  become: true
  when: ansible_facts['distribution_major_version'] == "11"
  ansible.builtin.apt: name=chrony state=removed autoremove=yes purge=yes

- name: install systemd-timesyncd
  become: true
  when: ansible_facts['distribution_major_version'] == "11"
  ansible.builtin.apt: name=systemd-timesyncd state=latest

- name: install dbus-broker
  become: true
  notify: reboot
  ansible.builtin.apt: name=dbus-broker state=latest

- name: hold kernel if upgrade is not required
  become: true
  when: update_kernel == false
  ansible.builtin.shell: apt-mark hold 'linux-image-*'

- name: upgrade all packages
  become: true
  ansible.builtin.apt:
    name: '*'
    state: latest
    autoclean: yes
    autoremove: yes
    update_cache: true
    install_recommends: no

- name: unhold kernel if needed
  become: true
  when: update_kernel == false
  ansible.builtin.shell: apt-mark unhold 'linux-image-*'

- name: check if a reboot is required
  ansible.builtin.shell: "[ -f /var/run/reboot-required ]"
  failed_when: False
  register: reboot_required
  changed_when: reboot_required.rc == 0
  notify: reboot
