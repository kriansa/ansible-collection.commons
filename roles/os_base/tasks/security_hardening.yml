---
- name: disable password SSH auth
  become: true
  notify: restart ssh
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PasswordAuthentication'
    line: PasswordAuthentication no

- name: disable root SSH auth
  become: true
  notify: restart ssh
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: PermitRootLogin no

- name: restrict su to wheel group only
  become: true
  ansible.builtin.lineinfile:
    path: /etc/pam.d/su
    line: auth required pam_wheel.so trust

- name: restrict passwordless sudo to wheel group only
  become: true
  ansible.builtin.copy:
    content: "%wheel ALL=(ALL) NOPASSWD:ALL"
    dest: /etc/sudoers.d/10-wheel
    mode: "0600"

# see: https://bugzilla.sudo.ws/show_bug.cgi?id=916
- name: disable dns lookups on sudo on debian
  become: true
  when: ansible_facts['os_family'] == 'Debian'
  ansible.builtin.copy:
    content: "Defaults !fqdn"
    dest: /etc/sudoers.d/01-no-fqdn
    mode: "0600"

- name: lock root user password
  become: true
  ansible.builtin.user:
    name: root
    password_lock: yes

- name: install sshguard
  become: true
  when: install_sshguard == true
  notify: restart sshguard
  ansible.builtin.package: state=latest name=sshguard

- name: open ports on firewalld
  become: true
  when: "'firewalld' in ansible_facts.packages"
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: yes
    immediate: yes
    state: enabled
  with_items: "{{ open_ports }}"
